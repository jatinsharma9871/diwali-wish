<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=yes" />
<title>Happy Diwali â€” With Love</title>
<style>
  :root{
    --bg:#080910;
    --bg2:#0c0d16;
    --accent:#ff4d8d;
    --gold:#ffd873;
    --text:#ffffff;
    --muted:#d8d8de;
    --stroke: rgba(255,255,255,0.12);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  * {
    box-sizing: border-box;
  }

  html {
    height: 100%;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
  }

  body {
    height: auto;
    min-height: 100vh;
    margin: 0;
    padding: 0;
    color: var(--text);
    background:
      radial-gradient(1200px 600px at 50% 10%, rgba(255,120,170,0.08), transparent 70%),
      radial-gradient(900px 500px at 80% 20%, rgba(255,210,140,0.06), transparent 70%),
      linear-gradient(180deg, #05060b 0%, var(--bg2) 100%);
    background-attachment: fixed;
    -webkit-font-smoothing: antialiased; 
    -moz-osx-font-smoothing: grayscale;
    -webkit-tap-highlight-color: transparent;
    touch-action: pan-y pinch-zoom;
    overflow-x: hidden;
    overflow-y: auto;
  }

  /* twinkling stars - fixed positioning for mobile */
  body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    z-index: 0;
    background-image:
      radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,0.25) 50%, transparent 51%),
      radial-gradient(1.5px 1.5px at 70% 10%, rgba(255,255,255,0.25) 50%, transparent 51%),
      radial-gradient(1.8px 1.8px at 40% 70%, rgba(255,255,255,0.22) 50%, transparent 51%),
      radial-gradient(1.6px 1.6px at 85% 60%, rgba(255,255,255,0.22) 50%, transparent 51%);
    background-repeat: no-repeat;
    filter: drop-shadow(0 0 4px rgba(255,255,255,0.25));
    animation: stars 6s ease-in-out infinite alternate;
  }
  @keyframes stars{
    from{opacity:0.7; transform:translateY(0px)}
    to{opacity:1; transform:translateY(-2px)}
  }

  .wrap {
    position: relative;
    min-height: 100vh;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 20px;
    padding-top: max(20px, env(safe-area-inset-top, 20px));
    padding-bottom: max(20px, env(safe-area-inset-bottom, 20px));
    flex-direction: column;
    text-align: center;
    z-index: 1;
    width: 100%;
    overflow: visible;
  }

  .card {
    position: relative;
    width: 100%; 
    max-width: 980px; 
    overflow: visible;
    border-radius: 20px;
    background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
    border: 1px solid var(--stroke);
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,0.04),
      0 20px 60px rgba(0,0,0,0.55);
    padding: 28px;
    backdrop-filter: blur(8px) saturate(120%);
    margin: auto;
    flex-shrink: 0;
  }
  .card::before {
    content: "";
    position: absolute;
    inset: -30% -40% auto -40%;
    height: 140%;
    background: conic-gradient(from 120deg at 50% 50%, rgba(255,160,200,0.08), rgba(255,220,160,0.12), rgba(140,180,255,0.06), rgba(255,160,200,0.08));
    filter: blur(40px);
    animation: aurora 14s linear infinite;
    pointer-events: none;
    z-index: -1;
  }
  @keyframes aurora{
    0%{transform:translateY(-8%) rotate(0deg)}
    50%{transform:translateY(6%) rotate(180deg)}
    100%{transform:translateY(-8%) rotate(360deg)}
  }

  h1 {
    font-size: 2.2rem;
    margin: 0 0 12px 0;
    letter-spacing: 0.3px;
    background: linear-gradient(135deg, #fff 0%, #ff8fb3 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  p.lead {
    margin: 0 0 18px 0;
    color: var(--muted);
    line-height: 1.5;
  }

  .row {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    justify-content: space-between;
    flex-wrap: wrap;
    position: relative;
    z-index: 2;
    width: 100%;
  }
  .left { flex: 1; min-width: 280px; }
  .right { width: 320px; min-width: 200px; display: flex; align-items: center; justify-content: center; position: relative; }

  /* diya cluster */
  .diyas { display: flex; gap: 16px; align-items: flex-end; justify-content: center; padding: 12px; }
  .diya { width: 78px; height: 128px; position: relative; display: flex; align-items: flex-end; justify-content: center; }
  .diya .base {
    width: 70px; height: 36px;
    background: radial-gradient(120% 120% at 50% 30%, #7a4a28 0%, #4c2b16 55%, #2e1b0f 100%);
    border-radius: 30px 30px 18px 18px;
    box-shadow: inset 0 8px 18px rgba(0,0,0,0.55), 0 6px 18px rgba(0,0,0,0.45);
    position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
  }
  .flame {
    width: 24px; height: 40px; border-radius: 50%;
    background: radial-gradient(circle at 50% 35%, #fff7c9 0%, #ffd873 22%, #ff9a3c 52%, #ff4b00 78%);
    position: absolute; bottom: 44px; left: 50%; transform: translateX(-50%) rotate(-8deg);
    filter: drop-shadow(0 10px 22px rgba(255,130,20,0.22));
    animation: flicker 1.2s infinite;
  }
  .halo {
    position: absolute; bottom: 56px; left: 50%; transform: translateX(-50%);
    width: 110px; height: 110px; border-radius: 50%;
    background: radial-gradient(closest-side, rgba(255,210,120,0.18), rgba(255,160,80,0.06), transparent 70%);
    filter: blur(8px); pointer-events: none;
  }
  .glow {
    position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
    width: 110px; height: 32px; border-radius: 50%;
    background: radial-gradient(ellipse at center, rgba(255,210,120,0.24), transparent 60%);
    filter: blur(6px); pointer-events: none;
  }
  @keyframes flicker{
    0%{transform:translateX(-50%) rotate(-7deg) scaleY(1)}
    40%{transform:translateX(-50%) rotate(5deg) scaleY(0.96)}
    100%{transform:translateX(-50%) rotate(-7deg) scaleY(1)}
  }

  /* message + jQuery heart */
  .message { margin: 16px 0; display: flex; flex-direction: column; gap: 14px; align-items: center; }
  .to-line { font-size: 1.1rem; font-weight: 600; }
  .type-line { max-width: 540px; margin: 0 auto; color: #e9e9ee; line-height: 1.6; min-height: 2.4em; font-size: 1rem; }

  /* jQuery heart */
  #jqHeartWrap { 
    display: inline-block; 
    position: relative; 
    filter: drop-shadow(0 12px 28px rgba(255,70,140,0.25));
    margin: 8px 0;
  }
  #jqHeart { will-change: transform; transition: filter .2s ease; }
  #jqHeartWrap:hover { filter: drop-shadow(0 14px 34px rgba(255,90,160,0.34)); }

  /* buttons - mobile scroll friendly */
  .cta {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
    margin: 20px 0;
    padding: 8px;
    width: 100%;
    position: relative;
    z-index: 10;
  }
  .btn {
    padding: 14px 20px;
    border-radius: 12px;
    border: 0;
    cursor: pointer;
    font-weight: 650;
    font-size: 15px;
    background: linear-gradient(180deg,#ff6a9a,#ff2e6f);
    color: #fff;
    box-shadow: 0 10px 24px rgba(0,0,0,0.44);
    transition: transform .15s ease, filter .2s ease;
    min-width: 140px;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
    position: relative;
    flex: 1;
    max-width: 200px;
  }
  .btn:active { transform: translateY(1px) scale(0.98); }
  .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
  .btn.secondary {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.18); 
    color: #fff;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }
  .btn.ghost {
    background: rgba(255,255,255,0.05);
    border: 2px solid rgba(255,255,255,0.25);
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    font-weight: 700;
  }

  /* canvases - fixed positioning with proper z-index */
  #fwCanvas, #petals, #fireflies {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none;
    z-index: 0;
  }
  #heartFx {
    position: absolute;
    inset: -15px;
    pointer-events: none;
    z-index: 2;
  }

  footer.note {
    margin: 20px 0 10px 0;
    color: #c7c7cf;
    font-size: 13px;
    line-height: 1.4;
    padding: 0 8px;
    text-align: center;
  }

  /* Mobile optimizations with proper scrolling */
  @media (max-width: 768px) {
    body {
      background-attachment: scroll;
    }
    
    .wrap {
      min-height: auto;
      align-items: center;
      padding: 12px;
      padding-top: max(12px, env(safe-area-inset-top, 12px));
      padding-bottom: max(40px, env(safe-area-inset-bottom, 40px));
      gap: 16px;
    }
    
    .card {
      padding: 16px;
      border-radius: 16px;
      margin: 0 auto;
      width: 100%;
      max-width: calc(100vw - 24px);
    }
    
    .row {
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }
    .right { width: 100%; order: -1; min-width: auto; }
    .left { min-width: auto; width: 100%; }
    
    h1 { font-size: 1.7rem; margin-bottom: 8px; }
    p.lead { font-size: 14px; margin-bottom: 14px; padding: 0 4px; }
    
    .diyas { gap: 10px; padding: 8px; }
    .diya { width: 65px; height: 115px; }
    .diya .base { width: 58px; height: 30px; }
    .flame { width: 18px; height: 32px; bottom: 36px; }
    .halo { width: 80px; height: 80px; bottom: 46px; }
    .glow { width: 80px; height: 24px; }
    
    #jqHeart { width: 90px; height: 82px; }
    #heartFx { width: 110px; height: 110px; inset: -10px; }
    
    .message { margin: 12px 0; }
    .to-line { font-size: 1rem; }
    .type-line { font-size: 15px; padding: 0 8px; max-width: 100%; }
    
    .cta {
      flex-direction: column;
      gap: 12px;
      margin: 20px 0;
      padding: 4px 8px;
      align-items: stretch;
    }
    .btn {
      padding: 18px 24px;
      font-size: 16px;
      min-width: auto;
      width: 100%;
      max-width: none;
      border-radius: 14px;
      font-weight: 700;
    }
    
    footer.note {
      font-size: 12px;
      margin: 20px 0 16px 0;
      padding: 0 12px;
    }
    
    /* Reduce visual complexity on mobile */
    .card::before { animation-duration: 25s; filter: blur(50px); }
    body::before {
      background-image:
        radial-gradient(1px 1px at 25% 35%, rgba(255,255,255,0.15) 50%, transparent 51%),
        radial-gradient(1px 1px at 75% 15%, rgba(255,255,255,0.15) 50%, transparent 51%);
    }
  }

  @media (max-width: 480px) {
    .wrap { 
      padding: 8px;
      padding-bottom: max(24px, env(safe-area-inset-bottom, 24px));
    }
    .card { padding: 12px; max-width: calc(100vw - 16px); }
    h1 { font-size: 1.5rem; }
    .diyas { gap: 6px; }
    .diya { width: 55px; height: 105px; }
    .btn { padding: 16px 20px; font-size: 15px; }
  }

  /* Landscape mobile with proper scrolling */
  @media (max-height: 600px) and (orientation: landscape) {
    .wrap {
      min-height: auto;
      padding: 8px;
      gap: 8px;
      align-items: flex-start;
    }
    .card { padding: 12px; }
    .diyas { padding: 4px; gap: 8px; }
    .diya { width: 50px; height: 90px; }
    h1 { font-size: 1.4rem; }
    .cta { margin: 12px 0; }
    .btn { padding: 12px 20px; }
    footer.note { margin: 8px 0; }
  }

  /* Reduce motion support */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
    .card::before { display: none; }
    body::before { animation: none; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" role="main" aria-live="polite">
    <canvas id="fwCanvas"></canvas>
    <canvas id="petals"></canvas>
    <canvas id="fireflies"></canvas>

    <div class="row">
      <div class="left">
        <h1>Happy Diwali</h1>
        <p class="lead">May every light that blooms tonight find a home in our hearts, and every spark remember our love by name.</p>

        <div class="diyas" aria-hidden="true">
          <div class="diya">
            <div class="flame" style="animation-duration:1.05s"></div>
            <div class="halo"></div>
            <div class="base"></div>
            <div class="glow" style="width:118px;"></div>
          </div>
          <div class="diya">
            <div class="flame" style="animation-duration:1.18s"></div>
            <div class="halo"></div>
            <div class="base" style="width:76px"></div>
            <div class="glow" style="width:106px;"></div>
          </div>
          <div class="diya">
            <div class="flame" style="animation-duration:0.96s"></div>
            <div class="halo"></div>
            <div class="base" style="width:64px"></div>
            <div class="glow" style="width:98px;"></div>
          </div>
        </div>

        <div class="message">
          <div class="heart-wrap" id="jqHeartWrap" aria-hidden="true">
            <svg id="jqHeart" width="120" height="110" viewBox="0 0 120 110" role="img" aria-label="Love heart">
              <defs>
                <linearGradient id="heartGrad" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stop-color="#ff71a9"/>
                  <stop offset="60%" stop-color="#ff2e6f"/>
                  <stop offset="100%" stop-color="#e3125a"/>
                </linearGradient>
                <linearGradient id="shineGrad" x1="0" y1="0" x2="1" y2="0">
                  <stop offset="0%" stop-color="rgba(255,255,255,0)" />
                  <stop offset="50%" stop-color="rgba(255,255,255,0.45)" />
                  <stop offset="100%" stop-color="rgba(255,255,255,0)" />
                </linearGradient>
                <clipPath id="heartClip">
                  <path id="heartPath" d="
                    M60,100
                    C 20,70 2,50 10,30
                    C 18,12 40,10 55,22
                    C 70,10 92,12 100,30
                    C 108,50 90,70 60,100 Z"/>
                </clipPath>
              </defs>
              <path d="M60,100 C 20,70 2,50 10,30 C 18,12 40,10 55,22 C 70,10 92,12 100,30 C 108,50 90,70 60,100 Z"
                    fill="url(#heartGrad)" stroke="rgba(255,255,255,0.18)" stroke-width="1"/>
              <rect id="shine" x="-150" y="0" width="140" height="110" fill="url(#shineGrad)" clip-path="url(#heartClip)" opacity="0.0"/>
            </svg>
            <canvas id="heartFx" width="140" height="140"></canvas>
          </div>

          <div>
            <strong id="toName" class="to-line">To: My Love</strong>
          </div>
          <p id="messageText" class="type-line"></p>
        </div>

        <div class="cta">
          <button class="btn" id="replayBtn">ðŸŽ† Fireworks</button>
          <button class="btn secondary" id="downloadBtn">ðŸ’¾ Download</button>
          <button class="btn ghost" id="musicBtn" aria-pressed="false">ðŸŽµ Loading Music...</button>
        </div>

        <footer class="note">âœ¨ Tap anywhere for fireworks â€¢ Watch petals drift â€¢ Music auto-plays on mobile</footer>
      </div>

      <div class="right" aria-hidden="true">
        <svg width="200" height="200" viewBox="0 0 200 200" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0" stop-color="#ffd873"/>
              <stop offset="1" stop-color="#ff6a6a"/>
            </linearGradient>
          </defs>
          <rect x="20" y="20" width="160" height="160" rx="24" ry="24" fill="url(#g1)" opacity="0.12" />
          <circle cx="100" cy="80" r="36" fill="rgba(255,255,255,0.06)"/>
          <g transform="translate(100,130)">
            <ellipse rx="52" ry="7" fill="rgba(0,0,0,0.25)"></ellipse>
          </g>
        </svg>
      </div>
    </div>
  </div>
</div>

<audio id="bgAudio" loop preload="auto" crossorigin="anonymous">
  <source src="https://drive.google.com/file/d/1PAWpGX-G0dTjjZ4IUm2Fyj31lJtSCQQS/view?usp=drivesdk" type="audio/mpeg" />
</audio>

<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<script>
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
const isLowEnd = navigator.hardwareConcurrency <= 2 || /Android.*Chrome\/[3-6][0-9]/i.test(navigator.userAgent);
const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

/* Enhanced audio with proper mobile scroll support */
(() => {
  const audio = document.getElementById('bgAudio');
  const btn = document.getElementById('musicBtn');
  let playing = false;
  let audioContext = null;
  let audioBuffer = null;
  let audioSource = null;

  btn.style.display = 'block';
  btn.style.visibility = 'visible';

  async function initWebAudio() {
    try {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const response = await fetch('https://cdn.pixabay.com/download/audio/2022/03/15/audio_4d5e7a5b7d.mp3?filename=soft-ambience-9944.mp3');
      const arrayBuffer = await response.arrayBuffer();
      audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
      return true;
    } catch (e) {
      return false;
    }
  }

  function playWebAudio() {
    if (audioContext && audioBuffer) {
      if (audioSource) {
        try { audioSource.stop(); } catch (e) {}
      }
      
      audioSource = audioContext.createBufferSource();
      const gainNode = audioContext.createGain();
      
      audioSource.buffer = audioBuffer;
      audioSource.loop = true;
      audioSource.connect(gainNode);
      gainNode.connect(audioContext.destination);
      gainNode.gain.setValueAtTime(0.25, audioContext.currentTime);
      
      audioSource.start(0);
      return true;
    }
    return false;
  }

  function stopWebAudio() {
    if (audioSource) {
      try { audioSource.stop(); } catch (e) {}
      audioSource = null;
    }
  }

  async function attemptAutoplay() {
    const attempts = [
      async () => {
        audio.muted = false;
        audio.volume = 0.25;
        await audio.play();
        return 'html5-direct';
      },
      async () => {
        audio.muted = true;
        await audio.play();
        await new Promise(resolve => setTimeout(resolve, 100));
        audio.muted = false;
        audio.volume = 0.25;
        return 'html5-muted';
      },
      async () => {
        if (!audioContext && !(await initWebAudio())) {
          throw new Error('Web Audio not available');
        }
        if (audioContext.state === 'suspended') {
          await audioContext.resume();
        }
        playWebAudio();
        return 'webaudio';
      }
    ];

    for (let i = 0; i < attempts.length; i++) {
      try {
        const method = await attempts[i]();
        playing = true;
        btn.textContent = 'ðŸ”Š Music Playing';
        btn.setAttribute('aria-pressed', 'true');
        btn.style.background = 'linear-gradient(180deg,#4ade80,#22c55e)';
        return true;
      } catch (e) {
        continue;
      }
    }
    return false;
  }

  const enableAudioOnInteraction = async (e) => {
    if (e.target.closest('#musicBtn')) return;
    
    const success = await attemptAutoplay();
    if (success) {
      ['click', 'touchstart', 'touchend', 'pointerdown'].forEach(event => {
        document.removeEventListener(event, enableAudioOnInteraction);
      });
    }
  };

  setTimeout(async () => {
    const success = await attemptAutoplay();
    if (!success) {
      btn.textContent = 'ðŸ”‡ Tap to Play Music';
      btn.setAttribute('aria-pressed', 'false');
      
      ['click', 'touchstart', 'touchend', 'pointerdown'].forEach(event => {
        document.addEventListener(event, enableAudioOnInteraction, { passive: true });
      });
    }
  }, 1000);

  btn.addEventListener('click', async (e) => {
    e.stopPropagation();
    e.preventDefault();
    
    if (!playing) {
      const success = await attemptAutoplay();
      if (!success) {
        btn.textContent = 'âŒ Audio Blocked';
        btn.style.background = 'linear-gradient(180deg,#f87171,#ef4444)';
      }
    } else {
      try { audio.pause(); } catch (e) {}
      stopWebAudio();
      if (audioContext) {
        try { await audioContext.suspend(); } catch (e) {}
      }
      
      playing = false;
      btn.textContent = 'ðŸ”‡ Music Off';
      btn.setAttribute('aria-pressed', 'false');
      btn.style.background = 'rgba(255,255,255,0.05)';
    }
  });
})();

/* Typewriter */
(() => {
  const line = "You are my brightest diya, and in your glow, every night learns how to be a festival.";
  const el = document.getElementById('messageText');
  let i = 0;
  function type() {
    if (i <= line.length) {
      el.textContent = line.slice(0, i++);
      setTimeout(type, isMobile ? 35 : 28);
    }
  }
  setTimeout(type, 600);
})();

/* Fireworks - scroll friendly */
(() => {
  const canvas = document.getElementById('fwCanvas');
  const ctx = canvas.getContext('2d');
  let W = canvas.width = window.innerWidth;
  let H = canvas.height = window.innerHeight;
  let particles = [];
  const TAU = Math.PI * 2;

  function rand(min = 0, max = 1) { return Math.random() * (max - min) + min; }
  function randInt(min, max) { return Math.floor(rand(min, max + 1)); }
  
  function resize() { 
    W = canvas.width = window.innerWidth; 
    H = canvas.height = window.innerHeight; 
  }
  window.addEventListener('resize', resize);

  class Particle {
    constructor(x, y, dx, dy, life, color, size) {
      this.x = x; this.y = y; this.dx = dx; this.dy = dy; this.life = life; this.age = 0;
      this.color = color; this.size = size;
    }
    step(dt) {
      this.age += dt;
      this.x += this.dx * dt;
      this.y += this.dy * dt + 0.02 * dt * dt;
      this.dy += 0.06 * dt;
      this.dx *= 0.997;
    }
    draw(ctx) {
      const t = this.age / this.life;
      ctx.globalAlpha = Math.max(1 - t, 0);
      ctx.beginPath();
      ctx.fillStyle = this.color;
      ctx.arc(this.x, this.y, Math.max(this.size * (1 - t * 0.88), 0.45), 0, TAU);
      ctx.fill();
    }
    alive() { return this.age < this.life; }
  }

  function burst(x, y, hueBase = randInt(0, 360), count = isMobile ? 20 : 34) {
    for (let i = 0; i < count; i++) {
      const angle = rand(0, TAU);
      const speed = rand(1.7, isMobile ? 5.5 : 6.7);
      const dx = Math.cos(angle) * speed;
      const dy = Math.sin(angle) * speed;
      const life = rand(46, isMobile ? 100 : 124);
      const size = rand(1.6, isMobile ? 4.2 : 4.8);
      const hue = (hueBase + randInt(-26, 26) + 360) % 360;
      const color = `hsl(${hue} ${randInt(72, 96)}% ${randInt(52, 66)}%)`;
      particles.push(new Particle(x, y, dx, dy, life, color, size));
    }
  }

  let last = performance.now();
  function loop(now) {
    const dtMs = now - last;
    last = now;
    const dt = Math.min(dtMs / 16.666, 4);
    ctx.fillStyle = 'rgba(6,7,12,0.26)';
    ctx.fillRect(0, 0, W, H);

    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      p.step(dt);
      if (!p.alive()) particles.splice(i, 1);
      else p.draw(ctx);
    }
    requestAnimationFrame(loop);
  }

  requestAnimationFrame(loop);

  function launchAt(x, y) {
    const burstCount = isMobile ? 2 : 3;
    for (let i = 0; i < burstCount; i++) {
      burst(x + (Math.random() * 40 - 20), y + (Math.random() * 40 - 20));
    }
  }

  // Use proper event handling that doesn't interfere with scroll
  document.addEventListener('pointerdown', (e) => {
    if (e.target.closest('.btn, .card')) return;
    launchAt(e.clientX, e.clientY);
  });

  document.getElementById('replayBtn').addEventListener('click', () => {
    launchAt(W * 0.5, H * 0.3);
    if (window.spawnHeartSparks) window.spawnHeartSparks(isMobile ? 8 : 12);
  });

  document.getElementById('downloadBtn').addEventListener('click', () => {
    try {
      const tmp = document.createElement('canvas');
      tmp.width = W; tmp.height = H;
      const tctx = tmp.getContext('2d');
      tctx.fillStyle = '#05060a';
      tctx.fillRect(0, 0, W, H);
      tctx.drawImage(canvas, 0, 0);
      const a = document.createElement('a');
      a.href = tmp.toDataURL('image/png');
      a.download = 'happy-diwali.png';
      a.click();
    } catch (err) {
      alert('Could not create image');
    }
  });

  resize();
})();

/* Petals */
(() => {
  const c = document.getElementById('petals');
  const ctx = c.getContext('2d');
  let W = c.width = window.innerWidth, H = c.height = window.innerHeight;

  const P = [];
  const COUNT = Math.min(isMobile ? 12 : 22, Math.floor(window.innerWidth / (isMobile ? 40 : 60)));
  
  function resize() { W = c.width = window.innerWidth; H = c.height = window.innerHeight; }
  window.addEventListener('resize', resize);

  for (let i = 0; i < COUNT; i++) {
    P.push({
      x: Math.random() * W, y: Math.random() * -H, z: Math.random() * 0.6 + 0.4,
      r: Math.random() * (isMobile ? 5 : 6) + (isMobile ? 5 : 6), 
      t: Math.random() * Math.PI * 2
    });
  }

  function drawPetal(x, y, r, t, shade) {
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(Math.sin(t) * 0.6);
    const grad = ctx.createRadialGradient(0, 0, 1, 0, 0, r);
    grad.addColorStop(0, `rgba(255,180,200,${shade})`);
    grad.addColorStop(1, `rgba(255,120,160,${shade * 0.85})`);
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.moveTo(0, -r * 0.8);
    ctx.quadraticCurveTo(r, -r * 0.3, 0, r);
    ctx.quadraticCurveTo(-r, -r * 0.3, 0, -r * 0.8);
    ctx.fill();
    ctx.restore();
  }

  function loop() {
    ctx.clearRect(0, 0, W, H);
    for (const p of P) {
      p.y += (isMobile ? 0.15 : 0.18) * p.z;
      p.x += Math.sin(p.t) * 0.15 * p.z;
      p.t += 0.01 * (2 - p.z);
      if (p.y > H + 20) { p.y = -20; p.x = Math.random() * W; }
      drawPetal(p.x, p.y, p.r, p.t, 0.8 * p.z);
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();

/* Fireflies */
(() => {
  const c = document.getElementById('fireflies');
  const ctx = c.getContext('2d');
  let W = c.width = window.innerWidth, H = c.height = window.innerHeight;
  
  const F = Array.from({ length: isMobile ? 10 : 16 }, () => ({
    x: Math.random() * W, y: Math.random() * H * 0.5 + 20,
    t: Math.random() * Math.PI * 2, r: Math.random() * 2 + 1
  }));
  
  function resize() { W = c.width = window.innerWidth; H = c.height = window.innerHeight; }
  window.addEventListener('resize', resize);

  function loop() {
    ctx.clearRect(0, 0, W, H);
    for (const f of F) {
      f.t += 0.01;
      f.x += Math.cos(f.t) * 0.4;
      f.y += Math.sin(f.t * 1.3) * 0.25;
      const g = ctx.createRadialGradient(f.x, f.y, 0.1, f.x, f.y, f.r * 3);
      g.addColorStop(0, 'rgba(255,240,180,0.9)');
      g.addColorStop(1, 'rgba(255,240,180,0.0)');
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
      ctx.fill();
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();

/* jQuery heart */
(function ($) {
  const $heart = $('#jqHeart');
  const $shine = $('#shine');

  let t0 = performance.now();
  function pulse(now) {
    if (reduceMotion) return;
    const t = (now - t0) / 1000;
    const s = 1 + Math.sin(t * (2 * Math.PI) / 1.5) * (isMobile ? 0.04 : 0.06);
    $heart.css('transform', 'scale(' + s + ')');
    requestAnimationFrame(pulse);
  }
  if (!reduceMotion) requestAnimationFrame(pulse);

  function sweep() {
    if (reduceMotion) return;
    $shine.css({ opacity: 0.0 });
    $shine.attr('x', -150);
    $shine.animate({ opacity: 0.85 }, 180, 'linear', function () {
      $({ x: -150 }).animate({ x: 130 }, {
        duration: isMobile ? 1200 : 1400,
        easing: 'swing',
        step: function (v) { $shine.attr('x', v); },
        complete: function () {
          $shine.animate({ opacity: 0.0 }, 260, 'linear');
          setTimeout(sweep, isMobile ? 2000 : 1600);
        }
      });
    });
  }
  if (!reduceMotion) sweep();

  const c = document.getElementById('heartFx');
  const ctx = c.getContext('2d');
  const W = c.width, H = c.height;
  const center = { x: W / 2, y: H / 2 + 6 };
  let sparks = [];

  function spawn(n = isMobile ? 3 : 5) {
    for (let i = 0; i < n; i++) {
      const a = Math.random() * Math.PI * 2;
      const r = (isMobile ? 14 : 18) + Math.random() * (isMobile ? 20 : 26);
      sparks.push({
        x: center.x + Math.cos(a) * r,
        y: center.y + Math.sin(a) * r,
        dx: (Math.random() - 0.5) * 0.6,
        dy: (Math.random() - 0.8) * 0.8,
        life: (isMobile ? 35 : 42) + Math.random() * 26,
        age: 0,
        size: 1 + Math.random() * (isMobile ? 1.5 : 1.8),
        hue: 330 + Math.random() * 30
      });
    }
  }
  window.spawnHeartSparks = spawn;

  let beat = setInterval(() => { if (!reduceMotion) spawn(); }, isMobile ? 600 : 500);

  let last = performance.now();
  function loop(now) {
    const dt = Math.min((now - last) / 16.666, 3);
    last = now;
    ctx.clearRect(0, 0, W, H);
    for (let i = sparks.length - 1; i >= 0; i--) {
      const p = sparks[i];
      p.age += dt;
      if (p.age > p.life) { sparks.splice(i, 1); continue; }
      p.x += p.dx * dt; p.y += p.dy * dt; p.dy += 0.02 * dt;
      const t = p.age / p.life;
      const alpha = Math.max(1 - t, 0);
      const grd = ctx.createRadialGradient(p.x, p.y, 0.1, p.x, p.y, p.size * 3);
      grd.addColorStop(0, `hsla(${p.hue}, 90%, 70%, ${0.85 * alpha})`);
      grd.addColorStop(1, `hsla(${p.hue}, 90%, 70%, 0)`);
      ctx.fillStyle = grd;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})(jQuery);
</script>
</body>
</html>
